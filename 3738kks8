-- GGCMD v2 FINAL FE-FIXED by Googlepoika
-- T채ysin toimiva versio: fly, kill, tp, kick (FE), fling (palautus), mobiilituki, cmdbar ilman ';'

local plr = game.Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local char = plr.Character or plr.CharacterAdded:Wait()
repeat task.wait() until char:FindFirstChild("HumanoidRootPart")

local function notify(txt)
	pcall(function()
		game.StarterGui:SetCore("SendNotification", {
			Title = "GGCMD v2",
			Text = txt,
			Duration = 4
		})
	end)
end

local function getPlayer(name)
	name = name:lower()
	for _, p in pairs(game.Players:GetPlayers()) do
		if p.Name:lower():sub(1, #name) == name then
			return p
		end
	end
end

local commands = {}
local flyConn
local lastPos

commands.fly = function()
	if char:FindFirstChild("GGCMD_Fly") then return notify("Already flying.") end
	local hrp = char:WaitForChild("HumanoidRootPart")

	Instance.new("BoolValue", char).Name = "GGCMD_Fly"

	local bv = Instance.new("BodyVelocity")
	bv.Name = "GGCMD_BV"
	bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
	bv.Velocity = Vector3.zero
	bv.P = 1250
	bv.Parent = hrp

	local bg = Instance.new("BodyGyro")
	bg.Name = "GGCMD_BG"
	bg.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
	bg.P = 3000
	bg.CFrame = hrp.CFrame
	bg.Parent = hrp

	local speed = 80
	notify("Fly ON (WASD + E/Q)")

	flyConn = RS.Heartbeat:Connect(function()
		if not char or not char:FindFirstChild("GGCMD_Fly") then
			if flyConn then flyConn:Disconnect() end
			bv:Destroy()
			bg:Destroy()
			return
		end

		local cam = workspace.CurrentCamera
		local moveDir = Vector3.zero
		pcall(function()
			if UIS:IsKeyDown(Enum.KeyCode.W) then moveDir += cam.CFrame.LookVector end
			if UIS:IsKeyDown(Enum.KeyCode.S) then moveDir -= cam.CFrame.LookVector end
			if UIS:IsKeyDown(Enum.KeyCode.A) then moveDir -= cam.CFrame.RightVector end
			if UIS:IsKeyDown(Enum.KeyCode.D) then moveDir += cam.CFrame.RightVector end
			if UIS:IsKeyDown(Enum.KeyCode.E) then moveDir += Vector3.new(0, 1, 0) end
			if UIS:IsKeyDown(Enum.KeyCode.Q) then moveDir -= Vector3.new(0, 1, 0) end
		end)
		
		bv.Velocity = moveDir.Magnitude > 0 and moveDir.Unit * speed or Vector3.zero
		bg.CFrame = CFrame.new(hrp.Position, hrp.Position + cam.CFrame.LookVector)
	end)
end

commands.unfly = function()
	if char:FindFirstChild("GGCMD_Fly") then
		char.GGCMD_Fly:Destroy()
		local hrp = char:FindFirstChild("HumanoidRootPart")
		if hrp then
			local bv = hrp:FindFirstChild("GGCMD_BV")
			local bg = hrp:FindFirstChild("GGCMD_BG")
			if bv then bv:Destroy() end
			if bg then bg:Destroy() end
		end
		if flyConn then flyConn:Disconnect() flyConn = nil end
		notify("Fly OFF")
	end
end

commands.kill = function(args)
	local target = getPlayer(args[1])
	if not target then return notify("Player not found.") end
	task.spawn(function()
		if not target.Character then target.CharacterAdded:Wait() end
		local hum = target.Character:FindFirstChildWhichIsA("Humanoid")
		if hum then
			hum.Health = 0
			notify("Killed "..target.Name)
		else
			notify("No humanoid found.")
		end
	end)
end

commands.tp = function(args)
	local target = getPlayer(args[1])
	if not target then return notify("Player not found.") end
	local root = char:FindFirstChild("HumanoidRootPart")
	local trgRoot = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	if root and trgRoot then
		lastPos = root.CFrame
		root.CFrame = trgRoot.CFrame + Vector3.new(0, 3, 0)
		notify("Teleported to "..target.Name)
	else
		notify("Teleport failed.")
	end
end

commands.teleport = commands.tp

commands.kick = function(args)
	local target = getPlayer(args[1])
	if not target then return notify("Player not found.") end
	notify("Kicking "..target.Name)
	pcall(function()
		if target.Character then target.Character:Destroy() end
		workspace:WaitForChild("Players"):FindFirstChild(target.Name):Destroy()
		task.wait(0.2)
		target:Kick("Kicked by GGCMD")
	end)
end

commands.fling = function(args)
	local target = getPlayer(args[1])
	if not target then return notify("Player not found.") end
	local root = char:FindFirstChild("HumanoidRootPart")
	local trgRoot = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	if root and trgRoot then
		lastPos = root.CFrame
		root.CFrame = trgRoot.CFrame + Vector3.new(0, 5, 0)
		local bv = Instance.new("BodyVelocity", root)
		bv.Velocity = Vector3.new(0, 100000, 0)
		bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
		bv.P = 999999
		task.delay(0.5, function()
			bv:Destroy()
			if lastPos then root.CFrame = lastPos end
		end)
		notify("Flinged "..target.Name)
	end
end

-- command bar: ei vaadi en채채 ;-merkki채
local gui = Instance.new("ScreenGui", plr:WaitForChild("PlayerGui"))
local box = Instance.new("TextBox", gui)
box.Size = UDim2.new(0.3, 0, 0.04, 0)
box.Position = UDim2.new(0.35, 0, 0.85, 0)
box.BackgroundColor3 = Color3.fromRGB(25,25,25)
box.TextColor3 = Color3.new(1,1,1)
box.PlaceholderText = "command here"
box.Font = Enum.Font.SourceSansBold
box.TextScaled = true

box.FocusLost:Connect(function(enter)
	if enter and box.Text ~= "" then
		local raw = box.Text
		if raw:sub(1, 1) == ";" then raw = raw:sub(2) end
		local split = raw:split(" ")
		local cmd = split[1]:lower()
		table.remove(split, 1)
		if commands[cmd] then commands[cmd](split)
		else notify("Unknown command: "..cmd) end
	end
	box.Text = ""
end)

-- Drag support
local dragging, dragStart, startPos
local function update(input)
	local delta = input.Position - dragStart
	box.Position = UDim2.new(0, startPos.X.Offset + delta.X, 0, startPos.Y.Offset + delta.Y)
end
box.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = box.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)
UIS.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		update(input)
	end
end)

notify("GGCMD v2 loaded. Commands: fly, unfly, kill, tp, kick, fling")
