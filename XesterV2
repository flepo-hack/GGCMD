-- Xester V2 Addon for GGCMD
-- Run after GGCMD main script. Gives costume + floating + 4 clickable tools.

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:FindFirstChildOfClass("PlayerGui") or localPlayer:WaitForChild("PlayerGui", 10)
local ggcmdGui = playerGui and playerGui:FindFirstChild("GGCMD")
local genv = (getgenv and getgenv()) or _G

if not ggcmdGui then
	warn("[Xester V2] GGCMD not found. Execute GGCMD first.")
	return
end

if not genv.foundRemote then
	warn("[Xester V2] GGCMD remote missing (getgenv().foundRemote). Execute GGCMD first.")
	return
end

local PREFIX = ";"
local TAG = "GGCMD_XESTER_V2"

local state = {
	enabled = false,
	tools = {},
	effects = {},
	cons = {},
	original = {
		walkSpeed = nil,
		jumpPower = nil
	},
	canSummonMinion = true
}

local function notify(title, text, duration)
	pcall(function()
		game:GetService("StarterGui"):SetCore("SendNotification", {
			Title = title,
			Text = text,
			Duration = duration or 3
		})
	end)
end

local function sendGGCMDCommand(raw)
	local msg = PREFIX .. raw
	if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
		local channel = TextChatService.TextChannels:FindFirstChild("RBXGeneral")
		if channel then
			pcall(function()
				channel:SendAsync(msg)
			end)
			return
		end
	end

	local legacy = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
	local say = legacy and legacy:FindFirstChild("SayMessageRequest")
	if say then
		pcall(function()
			say:FireServer(msg, "All")
		end)
	end
end

local function trackEffect(inst, life)
	table.insert(state.effects, inst)
	if life and life > 0 then
		Debris:AddItem(inst, life)
	end
	return inst
end

local function clearEffects()
	for _, inst in ipairs(state.effects) do
		if inst and inst.Parent then
			inst:Destroy()
		end
	end
	table.clear(state.effects)
end

local function clearTools()
	for _, tool in ipairs(state.tools) do
		if tool and tool.Parent then
			tool:Destroy()
		end
	end
	table.clear(state.tools)
end

local function disconnectAll()
	for _, con in ipairs(state.cons) do
		if con then con:Disconnect() end
	end
	table.clear(state.cons)
end

local function getCharacter()
	local char = localPlayer.Character or localPlayer.CharacterAdded:Wait()
	local hum = char:FindFirstChildOfClass("Humanoid")
	local hrp = char:FindFirstChild("HumanoidRootPart")
	return char, hum, hrp
end

local function nearestTarget(maxDistance)
	local _, _, hrp = getCharacter()
	if not hrp then return nil end

	local best, bestDist
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= localPlayer and plr.Character then
			local root = plr.Character:FindFirstChild("HumanoidRootPart")
			if root then
				local dist = (root.Position - hrp.Position).Magnitude
				if dist <= maxDistance and (not bestDist or dist < bestDist) then
					best, bestDist = plr, dist
				end
			end
		end
	end
	return best
end

local function createCardVisual(parent, size, color)
	local card = Instance.new("Part")
	card.Name = TAG .. "_Card"
	card.Anchored = true
	card.CanCollide = false
	card.Material = Enum.Material.Neon
	card.Color = color
	card.Size = size
	card.Transparency = 0.05
	card.Parent = parent
	return card
end

local function applyXesterLook()
	local char, hum, hrp = getCharacter()
	if not char or not hum or not hrp then return end

	state.original.walkSpeed = hum.WalkSpeed
	state.original.jumpPower = hum.JumpPower
	hum.WalkSpeed = 35
	hum.JumpPower = 62

	for _, d in ipairs(char:GetDescendants()) do
		if d:IsA("BasePart") then
			d.Material = Enum.Material.SmoothPlastic
			if d.Name:find("Arm") then
				d.Color = Color3.fromRGB(122, 18, 138)
			elseif d.Name:find("Leg") then
				d.Color = Color3.fromRGB(28, 28, 28)
			end
		end
	end

	local torso = char:FindFirstChild("UpperTorso") or char:FindFirstChild("Torso")
	if torso then
		local collar = Instance.new("Part")
		collar.Name = TAG .. "_JesterCollar"
		collar.CanCollide = false
		collar.Anchored = false
		collar.Material = Enum.Material.Neon
		collar.Color = Color3.fromRGB(255, 215, 60)
		collar.Size = Vector3.new(2.5, 0.25, 2.5)
		collar.Parent = char
		trackEffect(collar)

		local weld = Instance.new("WeldConstraint")
		weld.Part0 = torso
		weld.Part1 = collar
		weld.Parent = collar
		collar.CFrame = torso.CFrame * CFrame.new(0, 0.7, 0)
	end

	local hatBase = char:FindFirstChild("Head")
	if hatBase then
		local hat = Instance.new("Part")
		hat.Name = TAG .. "_JesterHat"
		hat.CanCollide = false
		hat.Anchored = false
		hat.Material = Enum.Material.Neon
		hat.Color = Color3.fromRGB(35, 35, 35)
		hat.Size = Vector3.new(1.9, 1, 1.9)
		hat.Parent = char
		trackEffect(hat)

		local hatWeld = Instance.new("WeldConstraint")
		hatWeld.Part0 = hatBase
		hatWeld.Part1 = hat
		hatWeld.Parent = hat
		hat.CFrame = hatBase.CFrame * CFrame.new(0, 0.9, 0)

		for i = 1, 3 do
			local horn = Instance.new("Part")
			horn.Name = TAG .. "_Horn" .. i
			horn.Anchored = false
			horn.CanCollide = false
			horn.Material = Enum.Material.Neon
			horn.Color = (i % 2 == 0) and Color3.fromRGB(225, 55, 55) or Color3.fromRGB(120, 18, 160)
			horn.Size = Vector3.new(0.3, 1.1, 0.3)
			horn.Parent = char
			trackEffect(horn)

			local hw = Instance.new("WeldConstraint")
			hw.Part0 = hat
			hw.Part1 = horn
			hw.Parent = horn

			local x = (i - 2) * 0.65
			horn.CFrame = hat.CFrame * CFrame.new(x, 0.75, 0)
		end
	end

	local floatCon = RunService.Heartbeat:Connect(function(t)
		if not state.enabled then return end
		local c, _, root = getCharacter()
		if not c or not root then return end
		local bob = math.sin(time() * 3.2) * 0.65
		root.AssemblyLinearVelocity = Vector3.new(root.AssemblyLinearVelocity.X, bob, root.AssemblyLinearVelocity.Z)
	end)
	table.insert(state.cons, floatCon)

	local orbit = Instance.new("Part")
	orbit.Name = TAG .. "_Orbit"
	orbit.Anchored = true
	orbit.CanCollide = false
	orbit.Transparency = 1
	orbit.Size = Vector3.new(1, 1, 1)
	orbit.Parent = workspace
	trackEffect(orbit)

	for i = 1, 6 do
		local card = createCardVisual(workspace, Vector3.new(0.25, 1.2, 0.8), Color3.fromRGB(245, 245, 245))
		trackEffect(card)
		local angleOffset = (math.pi * 2 / 6) * i
		local c = RunService.RenderStepped:Connect(function()
			if not state.enabled then return end
			local _, _, root = getCharacter()
			if not root or not card.Parent then return end
			local radius = 2.8
			local angle = time() * 2 + angleOffset
			card.CFrame = CFrame.new(root.Position + Vector3.new(math.cos(angle) * radius, 1.6 + math.sin(angle * 2) * 0.25, math.sin(angle) * radius)) * CFrame.Angles(0, angle, math.rad(90))
		end)
		table.insert(state.cons, c)
	end
end

local function doCardBlackHole()
	local _, _, hrp = getCharacter()
	if not hrp then return end
	local center = hrp.Position + hrp.CFrame.LookVector * 13

	local disc = createCardVisual(workspace, Vector3.new(16, 0.2, 16), Color3.fromRGB(18, 18, 18))
	disc.Shape = Enum.PartType.Cylinder
	disc.CFrame = CFrame.new(center) * CFrame.Angles(math.rad(90), 0, 0)
	trackEffect(disc, 2)

	local spinCon
	spinCon = RunService.RenderStepped:Connect(function(dt)
		if not disc.Parent then
			if spinCon then spinCon:Disconnect() end
			return
		end
		disc.CFrame = disc.CFrame * CFrame.Angles(0, dt * 12, 0)
	end)
	table.insert(state.cons, spinCon)

	for _ = 1, 4 do
		local t = nearestTarget(22)
		if t then
			sendGGCMDCommand("wither " .. t.Name .. " 0.2") -- light ticks (~20-25 style)
		end
		task.wait(0.2)
	end
end

local function doSuperiorLightning(target)
	if not target then
		target = nearestTarget(120)
	end
	if not target then
		notify("Xester V2", "No target for Superior Lightning", 2)
		return
	end

	local tChar = target.Character
	local tRoot = tChar and tChar:FindFirstChild("HumanoidRootPart")
	if not tRoot then return end

	for i = 1, 3 do
		local card = createCardVisual(workspace, Vector3.new(1, 1.2, 0.2), Color3.fromRGB(255, 244, 145))
		card.CFrame = tRoot.CFrame * CFrame.new((i - 2) * 2, 14, 0)
		trackEffect(card, 0.5)

		local bolt = Instance.new("Part")
		bolt.Anchored = true
		bolt.CanCollide = false
		bolt.Material = Enum.Material.Neon
		bolt.Color = Color3.fromRGB(255, 255, 160)
		bolt.Size = Vector3.new(0.28, 14, 0.28)
		bolt.CFrame = tRoot.CFrame * CFrame.new((i - 2) * 1.2, 7, 0)
		bolt.Parent = workspace
		trackEffect(bolt, 0.2)
	end

	sendGGCMDCommand("wither " .. target.Name .. " 0.25") -- ~25 damage style
	notify("Xester V2", "Superior Lightning on " .. target.Name, 2)
end

local function doSuperiorBomb()
	local _, _, hrp = getCharacter()
	if not hrp then return end

	for _ = 1, 3 do
		local t = nearestTarget(20)
		if t then
			sendGGCMDCommand("bring " .. t.Name)
		end
		task.wait(0.08)
	end

	local blast = Instance.new("Part")
	blast.Anchored = true
	blast.CanCollide = false
	blast.Shape = Enum.PartType.Ball
	blast.Material = Enum.Material.Neon
	blast.Color = Color3.fromRGB(255, 80, 60)
	blast.Size = Vector3.new(1, 1, 1)
	blast.CFrame = hrp.CFrame
	blast.Parent = workspace
	trackEffect(blast, 0.35)
	TweenService:Create(blast, TweenInfo.new(0.28, Enum.EasingStyle.Quint, Enum.EasingDirection.Out), {
		Size = Vector3.new(18, 18, 18),
		Transparency = 1
	}):Play()

	local t = nearestTarget(20)
	if t then
		sendGGCMDCommand("kill " .. t.Name) -- heavy hit / 100-like
	end
end

local function spawnMinion()
	if not state.canSummonMinion then
		notify("Xester V2", "Ability already used this life", 2)
		return
	end
	state.canSummonMinion = false

	local _, _, hrp = getCharacter()
	if not hrp then return end

	local minion = Instance.new("Model")
	minion.Name = TAG .. "_Minion"
	minion.Parent = workspace
	trackEffect(minion, 14)

	local body = Instance.new("Part")
	body.Name = "Body"
	body.Size = Vector3.new(2, 3, 1.5)
	body.Material = Enum.Material.Metal
	body.Color = Color3.fromRGB(55, 55, 55)
	body.CanCollide = true
	body.CFrame = hrp.CFrame * CFrame.new(2.5, 0, -3)
	body.Parent = minion

	local hammer = Instance.new("Part")
	hammer.Name = "Hammer"
	hammer.Size = Vector3.new(0.7, 3.3, 0.7)
	hammer.Material = Enum.Material.Metal
	hammer.Color = Color3.fromRGB(180, 180, 180)
	hammer.CanCollide = false
	hammer.Parent = minion
	local hw = Instance.new("WeldConstraint")
	hw.Part0 = body
	hw.Part1 = hammer
	hw.Parent = hammer
	hammer.CFrame = body.CFrame * CFrame.new(1.2, 0.2, 0)

	local hum = Instance.new("Humanoid")
	hum.MaxHealth = 100
	hum.Health = 100
	hum.WalkSpeed = 23
	hum.Parent = minion
	minion.PrimaryPart = body

	local target = nearestTarget(80)
	if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
		hum:MoveTo(target.Character.HumanoidRootPart.Position)
		local touchCon
		touchCon = body.Touched:Connect(function(hit)
			local model = hit and hit:FindFirstAncestorOfClass("Model")
			local plr = model and Players:GetPlayerFromCharacter(model)
			if plr and plr ~= localPlayer then
				sendGGCMDCommand("wither " .. plr.Name .. " 0.5") -- medium hit / 50-like
				if touchCon then touchCon:Disconnect() end
			end
		end)
		table.insert(state.cons, touchCon)
	end

	notify("Xester V2", "Minion summoned", 2)
end

local function makeTool(name, color, onActivated)
	local backpack = localPlayer:FindFirstChildOfClass("Backpack")
	if not backpack then return end

	local tool = Instance.new("Tool")
	tool.Name = name
	tool.RequiresHandle = true
	tool.CanBeDropped = false

	local handle = Instance.new("Part")
	handle.Name = "Handle"
	handle.Material = Enum.Material.Neon
	handle.Color = color
	handle.Size = Vector3.new(1, 1, 2)
	handle.CanCollide = false
	handle.Parent = tool

	tool.Activated:Connect(onActivated)
	tool.Parent = backpack
	table.insert(state.tools, tool)
end

local function enableXester()
	state.enabled = true
	clearEffects()
	clearTools()
	disconnectAll()
	state.canSummonMinion = true

	applyXesterLook()
	makeTool("Card Black Hole", Color3.fromRGB(25, 25, 25), doCardBlackHole)
	makeTool("Superior Lightning", Color3.fromRGB(253, 236, 115), function() doSuperiorLightning() end)
	makeTool("Superior Bomb", Color3.fromRGB(255, 84, 84), doSuperiorBomb)
	makeTool("Ability: Summon Minion", Color3.fromRGB(160, 160, 160), spawnMinion)

	local _, hum = getCharacter()
	if hum then
		local diedCon = hum.Died:Connect(function()
			state.canSummonMinion = true
		end)
		table.insert(state.cons, diedCon)
	end

	local keyCon = UserInputService.InputBegan:Connect(function(input, gpe)
		if gpe then return end
		if input.KeyCode == Enum.KeyCode.Y then
			doSuperiorLightning()
		end
	end)
	table.insert(state.cons, keyCon)

	notify("Xester V2", "Enabled: floating jester + 4 tools (+Y lightning)", 4)
end

local function disableXester()
	state.enabled = false
	clearTools()
	clearEffects()
	disconnectAll()

	local _, hum = getCharacter()
	if hum and state.original.walkSpeed then
		hum.WalkSpeed = state.original.walkSpeed
		hum.JumpPower = state.original.jumpPower or hum.JumpPower
	end

	notify("Xester V2", "Disabled", 2)
end

enableXester()

localPlayer.Chatted:Connect(function(msg)
	local m = msg:lower()
	if m == PREFIX .. "xesterv2off" then
		disableXester()
	elseif m == PREFIX .. "xesterv2" then
		enableXester()
	end
end)
